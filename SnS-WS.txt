// IMPORTANT: Replace with your actual Gemini API key.
// Ensure this API key has no HTTP referrer restrictions for GitHub Pages,
// or add "https://varun-1109.github.io/*" as an allowed HTTP referrer in Google Cloud Console.
const API_KEY = "AIzaSyBbxlaWwMjDJSkUzhhSXLs2aUR4Rr6XGDQ";

// Get references to HTML elements
const wordInput = document.getElementById('wordInput');
const searchButton = document.getElementById('searchButton');
const messageDisplay = document.getElementById('messageDisplay');
const definitionOutput = document.getElementById('definitionOutput');
const imageDisplay = document.getElementById('imageDisplay'); // New: Reference to the image display div


/**
 * Displays a message to the user.
 * @param {string} message - The message text.
 * @param {'info'|'error'|'success'} type - The type of message (for styling).
 */
function showMessage(message, type) {
    messageDisplay.textContent = message;
    messageDisplay.className = `message ${type}`; // Apply base and type-specific classes
    messageDisplay.classList.remove('hidden'); // Make sure it's visible
}

/**
 * Clears any displayed messages.
 */
function clearMessage() {
    messageDisplay.classList.add('hidden'); // Hide the message div
    messageDisplay.textContent = ''; // Clear text content
}

/**
 * Searches for the English word definition using the Gemini API.
 */
async function searchWord() {
    const word = wordInput.value.trim(); // Get word and remove whitespace

    if (!word) {
        showMessage('Please enter an English word.', 'error');
        definitionOutput.innerHTML = '<div id="imageDisplay"></div>'; // Clear previous definition and keep image div
        imageDisplay.innerHTML = ''; // Clear image
        return;
    }

    clearMessage();
    showMessage('Searching for definition...', 'info');
    definitionOutput.innerHTML = '<div id="imageDisplay"></div>'; // Clear previous definition and keep image div
    imageDisplay.innerHTML = ''; // Clear image

    let chatHistory = [];
    // Prompt the LLM to get the definition in the desired structured JSON format
    const prompt = `Provide the Hindi meaning, English meaning, and a simple example sentence for the English word '${word}' in JSON format.
    The JSON should have the following keys:
    "word": (the English word you provided)
    "hindiMeaning": (Hindi translation of the word)
    "englishMeaning": (English definition of the word)
    "exampleSentence": (a simple sentence using the word)
    Ensure the example sentence is easy to understand for a student learning English.`;

    chatHistory.push({ role: "user", parts: [{ text: prompt }] });

    // Define the expected JSON schema for the LLM response
    const payload = {
        contents: chatHistory,
        generationConfig: {
            responseMimeType: "application/json",
            responseSchema: {
                type: "OBJECT",
                properties: {
                    "word": { "type": "STRING" },
                    "hindiMeaning": { "type": "STRING" },
                    "englishMeaning": { "type": "STRING" },
                    "exampleSentence": { "type": "STRING" }
                },
                // Ensure the order of properties in the response
                "propertyOrdering": ["word", "hindiMeaning", "englishMeaning", "exampleSentence"]
            }
        }
    };

    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${API_KEY}`;

    try {
        const response = await fetch(apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`API request failed with status ${response.status}: ${errorText}`);
        }

        const result = await response.json();

        // Check if the response structure is as expected
        if (result.candidates && result.candidates.length > 0 &&
            result.candidates[0].content && result.candidates[0].content.parts &&
            result.candidates[0].content.parts.length > 0) {

            const jsonString = result.candidates[0].content.parts[0].text;
            const definitionData = JSON.parse(jsonString);

            // Validate that all required fields are present in the parsed JSON
            if (definitionData.word && definitionData.hindiMeaning &&
                definitionData.englishMeaning && definitionData.exampleSentence) {
                displayDefinition(definitionData);
                showMessage('Definition found!', 'success');
            } else {
                throw new Error('Received incomplete or malformed data from the LLM.');
            }
        } else {
            throw new Error('No valid content found in the LLM response.');
        }

    } catch (error) {
        console.error('Error fetching definition:', error);
        showMessage(`Could not find a definition or an error occurred: ${error.message}. Please try again or a different word.`, 'error');
    }
}

/**
 * Returns a direct URL for a clipart image from Openclipart based on the word.
 * This function uses a manual mapping for demonstration. You would expand this map
 * for more words or integrate a dynamic image search if an API was available.
 *
 * IMPORTANT: Always respect licenses for images. Openclipart images are generally
 * public domain, but always verify.
 * @param {string} word - The English word.
 * @returns {string|null} - The URL of the image or null if not found.
 */
function getImageForWord(word) {
    const lowerCaseWord = word.toLowerCase();
    const imageMap = {
        "apple": "https://openclipart.org/image/800px/212623", // Example: A red apple
        "dog": "https://openclipart.org/image/800px/204739", // Example: A simple dog outline
        "cat": "https://openclipart.org/image/800px/222921", // Example: A cartoon cat
        "sun": "https://openclipart.org/image/800px/191599", // Example: A smiling sun
        "book": "https://openclipart.org/image/800px/107775", // Example: An open book
        "car": "https://openclipart.org/image/800px/292025", // Example: A simple car
        "house": "https://openclipart.org/image/800px/32187", // Example: A house
        "tree": "https://openclipart.org/image/800px/168172", // Example: A tree
        // Add more words and their corresponding Openclipart URLs here
    };
    return imageMap[lowerCaseWord] || null;
}


/**
 * Displays the word definition in a table format and includes a pictorial representation.
 * @param {object} data - The definition data (word, hindiMeaning, englishMeaning, exampleSentence).
 */
function displayDefinition(data) {
    // Get image URL
    const imageUrl = getImageForWord(data.word);

    // Clear previous content in imageDisplay before adding new image
    imageDisplay.innerHTML = '';
    if (imageUrl) {
        imageDisplay.innerHTML = `<img src="${imageUrl}" alt="${data.word} clipart">`;
    }

    // Display the definition table in definitionOutput (which already contains imageDisplay div)
    definitionOutput.innerHTML += `
        <table class="min-w-full">
            <thead>
                <tr>
                    <th>Word</th>
                    <th>Hindi Meaning</th>
                    <th>English Meaning</th>
                    <th>Example Sentence</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>${data.word}</td>
                    <td>${data.hindiMeaning}</td>
                    <td>${data.englishMeaning}</td>
                    <td>${data.exampleSentence}</td>
                </tr>
            </tbody>
        </table>
    `;
}

// Add event listener to the search button
searchButton.addEventListener('click', searchWord);

// Allow searching by pressing Enter in the input field
wordInput.addEventListener('keypress', (event) => {
    if (event.key === 'Enter') {
        searchWord();
    }
});

// Initial message to guide the user
window.onload = () => {
    showMessage('Type an English word and click "Search Word" to get its definition.', 'info');
};
